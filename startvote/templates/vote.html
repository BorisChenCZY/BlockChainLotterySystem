<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    {#    以下三行用于禁止缓存#}
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Vote</title>
    <link rel="stylesheet" type="text/css" href="/static/css/isotope.css" media="screen"/>
    <link rel="stylesheet" href="/static/js/fancybox/jquery.fancybox.css" type="text/css" media="screen"/>
    <!-- skin -->
    <script src="/static/js/jquery-1.11.1.min.js"></script>
    <script src="/static/js/popper.min.js"></script>
{#    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js"#}
{#            integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4"#}
{#            crossorigin="anonymous"></script>#}
    <script src="/static/js/jsrsasign-all-min.js"></script>
    <script src="/static/js/encryption.js"></script>
    <link rel="stylesheet" href="/static/css/bootstrap.css">
    <link rel="stylesheet" href="/static/css/bootstrap-theme.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/skin/default.css">
    <script src="/static/js/socket.io.dev.js"></script>
    <script src="/static/js/jquery-1.10.2.min.js"></script>
{#        <script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>#}

    {#    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">#}



    <!------ Include the above in your HEAD tag ---------->

    <style type="text/css">

        .mr-3{
            margin-right: 1rem!important;
        }
        .media-body{
            flex: 1;
        }
        .mt-0{
            margin-top: 0!important;
        }

        .middle{
            margin-right: auto;
            margin-left: auto;
            width: 256px;
        }
        body {
            color: #fff;
            background: #65B0A7;
        }

        html {
            font-family: Lato, 'Helvetica Neue', Arial, Helvetica, sans-serif;
            font-size: 14px;
        }

        .float-right{
            margin-right:-30px;
        }

        h5 {
            font-size: 1.28571429em;
            font-weight: 700;
            line-height: 1.2857em;
            margin: 0;
        }

        .card {
            margin-top: 20px;
            margin-bottom: 20px;
            font-size: 1em;
            overflow: hidden;
            padding: 0;
            border: none;
            border-radius: .28571429rem;
            box-shadow: 0 1px 3px 0 #d4d4d5, 0 0 0 1px #d4d4d5;
        }

        .card-null {
            box-shadow: none;
        }

        .card-block {
            font-size: 1em;
            position: relative;
            margin: 0;
            padding: 1em;
            border: none;
            border-top: 1px solid rgba(34, 36, 38, .1);
            box-shadow: none;
        }


        .card-inverse .btn {
            border: 1px solid rgba(0, 0, 0, .05);
        }

        .card-inverse .btn-null {
            border: hidden;
        }

        .profile {
            position: absolute;
            top: -12px;
            display: inline-block;
            overflow: hidden;
            box-sizing: border-box;
            width: 25px;
            height: 25px;
            margin: 0;
            border: 1px solid #fff;
            border-radius: 50%;
        }

        .profile-avatar {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 50%;
        }

        .profile-inline {
            position: relative;
            top: 0;
            display: inline-block;
        }

        .profile-inline ~ .card-title {
            display: inline-block;
            margin-left: 4px;
            vertical-align: top;
        }

        .text-bold {
            font-weight: 700;
        }

        .meta {
            font-size: 1em;
            color: rgba(0, 0, 0, .4);
        }

        .meta a {
            text-decoration: none;
            color: rgba(0, 0, 0, .4);
        }

        .meta a:hover {
            color: rgba(0, 0, 0, .87);
        }

        .btn-null {
            background-color: inherit;
        }

        .mycontainer {
            border-radius: 10px 10px 10px 10px;
            margin-top: 50px;
            margin-bottom: 20px;
            background: #ffffff;
            box-shadow: 0px 5px 5px rgba(0, 0, 0, 0.3);
            padding-bottom: 30px;
            padding-left: 90px;
            padding-right: 90px;
        }

        .form-title-row {
            display: inline-block;
            box-sizing: border-box;
            color: #4c565e;
            font-size: 24px;
            padding-top: 30px;
            border-bottom: 2px solid #6caee0;
            margin: 0;
        }

        .myfont {
            font: 14px/1.5 Arial, Helvetica, sans-serif;
            font-size: 40px;
            line-height: 30px;
            font-weight: 500;
            color: #4c565e;
        }

        .smallerfont{
            font-size: 22px;
            font-weight: 600;
        }

        .list-group-item {
            color: #000000;
        }

        .active {
            color: #ffffff;
        }

        .row {
            margin-top: 20px;
            margin-bottom: 20px;
            margin-left: 0px;
            margin-right: 0px;
        }

        .progress {
        {#margin-top: 20px;#} height: 40px;
            line-height: 40px;
            margin-bottom: 0px;
            position: relative;
        }

        .progress-bar {
        {#position: relative;#} line-height: 40px;
            font-size: 18px;
            text-align: left;
        {#padding-left: 15px;#}
        }

        .progress span {
            margin-left: 15px;
            position: absolute;
        }

        .progress button {
            float: right;
            height: 100%;
            width: 10%;
            text-align: center;
            padding-left: 0px;
            padding-right: 0px;
        }

        .vote_img {
            max-width: 100px;
            float: left;
            margin-right: 3px;
        }
        .adjustsize {
            padding-left: 40%;
        }
        .adjustsize2{
            margin-left: 40%;
        }

        @media (max-width: 767px) {


            .media-heading{
                font-size: 10px;
            }

            .progress button{
                width: 20%;
            }

            .adjustsize {
                padding-left: 30%;
            }
            .myfont{
                font-size: 32px;
                line-height: 36px;
            }
            .smallerfont{
                font-size: 22px;
                font-weight: 600;
            }
            .float-right{
                margin-right:0px;
            }
            .card{
                margin-top: 10px;
                margin-bottom: 10px;

            }
            .mycontainer{
                margin-top: 20px;
                padding-left: 20px;
                padding-right: 20px;
                padding-bottom: 10px;
            }
            .col-lg-3{
                width: 50%;
                padding-right: 7px;
                padding-left: 7px;
            }
            .card-title {
                font-size: 0.85em;
                margin-bottom: 5px;
            }
            .card-text {
                font-size: 10px;
                margin-top: 0em;
                height: 36px;
                line-height: 12px;
            }
            .cover {
                height: 100px;
            }
            .adjustsize2{
                margin-left: 35%;
            }
            .smallermargin{
                margin-top: 0;
            }


        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        /* Hide default HTML checkbox */
        .switch input {
            display: none;
        }

        /* The slider */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

    </style>

</head>

<body>
<div class="container">

    <div class="container mycontainer">

        <div class="row smallermargin" style="color: #000;">
            <div class="form-title-row">
                <a><h1 style="float: left;" class="myfont">{{ vote.vote_name }}</h1></a>
                <i data-toggle="modal" data-target="#exampleModal" class="fa fa-share-square-o"
                   style="margin-left: 10px"></i>
            </div>

            <div style="margin: 10px"> {{ type }}</div>
            <div style="margin: 10px"> {{ vote.vote_description }}</div>
        </div>
        <div class="row">
            <div style="float:left; margin-top:0.4%; margin-left:0.5%; margin-right:1%;">
                <span style="color: #000000; vertical-align: top; margin-top: 100%; font-size:110%">Real Time Result</span>
            </div>

            <!-- Rounded switch -->
            <label class="switch" style="float:left;" id="realTimeResult">
                <input type="checkbox" id="resultCheckBox">
                <span class="slider round"></span>
            </label>
            <button id="showall" style="float: right" type="button" class="btn btn-success" data-toggle="collapse"
                    data-target=".candidates" style="float: top">Show All Details
            </button>
        </div>


        {% for c in candidate %}
            <div class="row">
                <div class="progress" style="position: relative;">
                    <button type="button" class="btn btn-success" data-toggle="collapse" aria-expanded="false"
                            aria-controls="{{ c.id }}"
                            data-target="#{{ c.id }}"> Details
                    </button>
                    <div class="progress" onclick="clicked(this)">
                        <span style="color:#000000; position:absolute;">{{ c.title }} {{ c.voteNum }}票</span>
                        <div class="progress-bar  progress-bar-info" role="progressbar" aria-valuenow="10"
                             aria-valuemin="0" aria-valuemax="100"
                             style="width: {{ c.width }}%; min-width:{{ c.width }}%"
                             id="prog{{ c.id }}">
                        </div>
                    </div>
                </div>

                <div class="panel panel-default collapse candidates" id="{{ c.id }}">
                    <div class="panel-collapse ">
                        <div class="panel-body">
                            <div class="media">
                                <img class="mr-3 vote_img"  src="{{ MEDIA_URL }}{{ c.img }}" alt="媒体对象">
                                <div class="media-body" style="color: black">
                                    <h5 class="mt-0 myfont smallerfont">{{c.title}}</h5>
                                    {{ c.simple }}<br>{{ c.detail }}
                                </div>
                            </div>
                            {##}
                            {##}
                            {#                            <div class="media">#}
                            {#                                <img class="align-self-end mr-3 img-thumbnail vote_img" src="{{ c.img }}" alt="媒体对象">#}
                            {#                                <div class="media-body">#}
                            {#                                    <h4 class="media-heading">{{c.simple}}</h4>#}
                            {#                                    <pre>{{ c.detail }}</pre>#}
                            {#                                </div>#}
                            {#                            </div>#}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}



        <div class="row center-block" style="margin-top: 35px; margin-bottom: 35px;">
            <p class="center-block">
                <a class="btn btn-primary" data-toggle="collapse" href="#multiCollapseExample1" role="button"
                   aria-expanded="false" aria-controls="multiCollapseExample1">Public Key</a>
                <button class="btn btn-primary" type="button" data-toggle="collapse"
                        data-target="#multiCollapseExample2" aria-expanded="false"
                        aria-controls="multiCollapseExample2">Private Key
                </button>
                <button class="btn btn-primary" type="button" data-toggle="collapse"
                        data-target="#multiCollapseExample3" aria-expanded="false"
                        aria-controls="multiCollapseExample3">Fake Public Key
                </button>
            </p>
            <div class="col" style="color: #000000">
                <div class="collapse multi-collapse" id="multiCollapseExample1">
                    <div class="card card-body">
                        <span id="pubkey">Generating...</span> <br>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" type="button"  data-toggle="collapse"
                        data-target="#multiCollapseExample2" aria-expanded="false"
                        aria-controls="multiCollapseExample2">Private Key
                </button>
            <div class="col" style="color: #000;">
                <div class="collapse multi-collapse" id="multiCollapseExample2">
                    <div class="card card-body">
                        <span id="privkey">Generating...</span>
                    </div>
                </div>
            </div>
            <div class="col" style="color: #000;">
                <div class="collapse multi-collapse" id="multiCollapseExample3">
                    <div class="card card-body">
                        <span id="fakepubkey">Generating...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <button type="button" class="btn btn-info center-block btn-lg btn-warning" id="Submit"
                    data-loading="<i class='fa fa-circle-o-notch fa-spin'></i> Processing Order"> Submit
            </button>
        </div>


    </div>
    <div>

        {#        <a href="{% url 'index' %}">#}
        {#        <button class="btn btn-info float-right btn-sm btn-lg" style="margin-bottom: 20px">#}
        {#                  Back</button></a>#}
        <a href="{% url 'index' %}"><button  type="button"  class="btn float-right" style="font-weight:600;margin-bottom:30px;color:white;background:teal;box-shadow: 0 3px 4px 0 rgba(0, 0, 0, .14), 0 3px 3px -2px rgba(0, 0, 0, .2), 0 1px 8px 0 rgba(0, 0, 0, .12)">
            &nbsp&nbspBack&nbsp&nbsp</button></a>

    </div>


    <!-- Modal -->

    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="width: 300px;margin-left: auto;margin-right: auto">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="middle">
                        <div id="qrcode3"></div>
                        <div style="margin-top: 10px">
                            <textarea id="copy" style="color: black;width: 77%;height:32px;float: left;overflow-x: auto">对应的网址</textarea>

                            <a><button type="button"  class="btn btn-primary"  onclick="copyLink();">Copy</button>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>
<script src="/static/js/modernizr-2.6.2-respond-1.1.0.min.js"></script>
<script src="/static/js/jquery.js"></script>
<script src="/static/js/jquery.easing.1.3.js"></script>
<script src="/static/js/bootstrap.min.js"></script>
<script src="/static/js/jquery.isotope.min.js"></script>
<script src="/static/js/jquery.nicescroll.min.js"></script>
<script src="/static/js/fancybox/jquery.fancybox.pack.js"></script>
<script src="/static/js/skrollr.min.js"></script>
<script src="/static/js/jquery.scrollTo.js"></script>
<script src="/static/js/jquery.localScroll.js"></script>
<script src="/static/js/stellar.js"></script>
<script src="/static/js/jquery.appear.js"></script>
<script src="/static/js/main.js"></script>
<script src="/static/contactform/contactform.js"></script>
<script type="text/javascript" src="/static/js/jquery.qrcode.min.js"></script>
<script src="/static/js/elliptic/lib/bundle.js"></script>
<script src="/static/js/md5.js"></script>

<script>
    String.prototype.replaceAt = function (index, replacement) {
        return this.substr(0, index) + replacement + this.substr(index + replacement.length);
    }

    function str2b(url) {
        var data = [];
        for (var i = 0; i < url.length; i++)
            data.push(url.charCodeAt(i));
        return data;
    }

    var EC = require('elliptic').ec;
    var utils = require('elliptic').utils;
    var ec = new EC('secp256k1');
    var pri_key = Math.random().toString(36).substr(2);
    var key = ec.keyFromPrivate(hex_md5(pri_key));
    var pub = key.getPublic();
    var pub_key = utils.toHex([4].concat(pub.x.toArray('big', 32), pub.y.toArray('big', 32)));
    $("#privkey").text(pri_key);
    $("#pubkey").text(pub_key);

    jQuery(function(){
        //二维码的跳转网页地址
        var test = window.location.href;
        jQuery('#qrcode3').qrcode(test);
    });

    var thisobj;
    var voteLimit = {{ voteLimit }};
    var selected_num = 0;
    var max_id = {{ max_id }};
    var miner_list = {{ miner_list|safe }};
    var showall = 0;
    var choose_color = "linear-gradient(to bottom, rgb(255, 102, 0) 0%, rgb(255, 80, 80) 100%)";
    var origin_color = "linear-gradient(to bottom, #5bc0de 0%, #31b0d5 100%)";

    function clicked(obj) {
        if (selected_num< voteLimit) {
            if (obj.children[1].style.width === "100%"){
                obj.children[1].style.backgroundImage=origin_color;
                obj.children[1].style.width=obj.children[1].style.minWidth;
                selected_num--;
            }
            else {
                obj.children[1].style.backgroundImage=choose_color;
                obj.children[1].style.width ="100%";
                selected_num++;
            }
        }else if(selected_num ===voteLimit){
            if (obj.children[1].style.width === "100%"){
                obj.children[1].style.backgroundImage=origin_color;
                obj.children[1].style.width=obj.children[1].style.minWidth;
                selected_num--;
            }
            else {
                 alert("选项数目达到上线");
            }

        }


    }
    $("#showall").click(function () {
        if(showall == 0){
            $(this).html("Hide All Details");
            showall++;
        }
        else {
            $(this).html("Show All Details");
            showall--;
        }
    });


    $("#Submit").on('click', function () {


        var id = [];
        var cnt = 0;
        for (var i = 1; i <= max_id; i++) {
            if ($("#prog" + i)[0].style.width === "100%") {
                id[cnt++] = i;
            }
        }
        console.log(id);
        if (cnt===0) {
            alert("You need to select at least one option.");
            return;
        }

        var target = "{{ target|safe }}";
        console.log(target);
        {#$(this).button("loading");#}
        $(this).html("<i class='fa fa-circle-o-notch fa-spin'></i> Submitting...");
        {#$(this).disable = true;#}
        var msg = {
            "target": target,
            "prob_num": 1,
            "selection": id
        };
        test_msg = msg;
        {#var s_d = JSON.stringify(d);#}
        {#console.log(typeof s_d)#}
        {#console.log(s_d);#}
        s = utils.toHex(ec.sign(str2b(JSON.stringify(msg)), key).toDER());
        console.log(s);

        console.log(key.verify(str2b(JSON.stringify(msg)), s, pub_key));
        var data = {
            "msg": msg,
            "sign": s,
            "pubkey": pub_key
        };
        console.log(msg);
       $(this).html("Done");
       {
        for (var i = 0; i < miner_list.length; i++) {
            var address = miner_list[i];
            console.log(address);
            var socket = io(address);
            console.log("hello");
            socket.emit("Vote", JSON.stringify(data));
            console.log("good");
           }
           {#window.location.href="logout.asp?act=logout"#}

        }

        alert("提交成功，即将退出投票页哈哈哈哈哈哈");
{#       window.history.back(-1);#}
        $(this).html("Done");

    })
    $("#realTimeResult").on("click", function () {
        {#timer = setInterval(getRealTimeResult, 1000);#}
        {#clearInterval(timer);#}
        if (document.getElementById('resultCheckBox').checked === false) {
            //pause timer
            console.log("closed timer");
            {#window.clearInterval(timer);#}
            {#window.clearInterval(timer);#}
            timer = false;
        } else {
            //continue timer
            timer = window.setInterval(getRealTimeResult, 1000);
            {#console.log("opened timer");#}
            timer = true;
        }
    })

    function getRealTimeResult() {
        if (!timer)
            return;
        console.log("retriving");
        $.ajax({
            type: "POST",
            url: "/result",
            data: {
                "url": document.URL,
            }
        }).done(function (info) {
            ans = info; // todo change ans to private
            total = 0;
            max = 0

            console.log("retrived");

            for (var key in ans) {
                // check if the property/key is defined in the object itself, not in parent
                if (ans.hasOwnProperty(key)) {
                    total += ans[key];
                    if (ans[key] > max)
                        max = ans[key];
                }
            }

            for (var key in ans) {
                // check if the property/key is defined in the object itself, not in parent
                if (ans.hasOwnProperty(key)) {
                    if (document.getElementsByClassName("progress-bar")[key - 1].style.width !== "100%")
                        document.getElementsByClassName("progress-bar")[key - 1].setAttribute("style", "width:" + ans[key] / max * 80 + "%")

                    var text = $("div.progress span")[key - 1].innerHTML;
                    text = text.replaceAt(text.search(" ") + 1, ans[key] + "票");
                    $("div.progress span")[key - 1].innerHTML = text;
                }
            }
        })
    }
</script>

</body>